name: AI Security Pipeline
on: [push]

jobs:
  security-analysis:
    name: Local Security Scan
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Bundle Code for Scanning
        run: |
          Write-Output "Packaging code..."
          git archive --format=tar.gz -o source_code.tar.gz HEAD . ":!.github" ":!docker-compose.yml"

      - name: Send to AI Engine
        run: |
          Write-Output "Sending to Django API at http://localhost:8000..."
          
          $REPO_NAME = "${{ github.repository }}"
          $COMMIT_HASH = git rev-parse HEAD
          $BRANCH_NAME = "${{ github.ref_name }}"
          $AUTHOR_EMAIL = "${{ github.actor }}"
          $REPO_URL = "${{ github.repository_url }}"
          $OWNER = "${{ github.repository_owner }}"

          Write-Output "   - Repo: $REPO_NAME"
          Write-Output "   - Commit: $COMMIT_HASH"
          Write-Output "   - Branch: $BRANCH_NAME"

          # Use curl.exe (the real tool) with backticks ` for line splitting in PowerShell
          & curl.exe -s -o response.json -w "%{http_code}" -X POST http://localhost:8000/api/scan/upload/ `
            -F "file=@source_code.tar.gz" `
            -F "repo_name=$REPO_NAME" `
            -F "commit_hash=$COMMIT_HASH" `
            -F "branch=$BRANCH_NAME" `
            -F "triggered_by=$AUTHOR_EMAIL" `
            -F "repo_url=$REPO_URL" `
            -F "owner=$OWNER"

          if (Test-Path response.json) {
             Get-Content response.json
          }